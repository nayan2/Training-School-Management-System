"use strict";StackExchange.tagEditor=function(e,t,n,i){function r(){R=!0}function a(){if("undefined"==typeof Q){for(var e=StackExchange.tagEditor.requiredTags,t=[],n=0;n<e.length;n++)t.push(e[n].Name.replace(/[.+]/g,"\\$&"));Q=new RegExp("^(?:"+t.join("|")+")$")}return Q}function o(){var e=StackExchange.tagEditor.requiredTags;if(e&&/^ ?$/.test(W.val())){var t=a();0===V.add(K).children().filter(function(){return t.test($(this).text())}).length&&S(StackExchange.tagEditor.requiredTags)}}function s(e,t){var n=window.tagRenderer(e,null,"span");return i.tagMenus&&n.data("tag-menu-tagname",e),t||(n.append($("<span>",{"class":"delete-tag","title":"remove this tag"})),j.trigger("tagSpanCreated",[n])),n}function l(e){var t=$([]),n=$([]);switch(e){case nt.all:t=V.find(".rendered-element"),n=K.find(".rendered-element");break;case nt.left:t=V.find(".rendered-element:last");break;case nt.right:n=K.find(".rendered-element:first");break;case nt.all_left:t=V.find(".rendered-element");break;case nt.all_right:n=K.find(".rendered-element")}return{"pre":t,"post":n}}function c(e){e=e||nt.all;var t=l(e),n=t.pre.map(function(e,t){return $(t).text()}).get(),i=n.join(" ");i.length&&(i+=" ");var r=t.post.map(function(e,t){return $(t).text()}).get(),a=r.join(" ");a.length&&W.val().length&&(a=" "+a);var o=W.val();return n=n.concat(r),{"text":i+W.val()+a,"lengthBeforeInput":i.length,"val":o,"tags":n}}function u(t){t=t||c(),setTimeout(function(){e.trigger("tageditor:renderedchange",[t.tags,t.val])})}function d(){var e=W.val();return(""===e||" "===e)&&0===V.add(K).children().filter(function(){return!/^\s*$/.test($(this).text())}).length}function p(e){e=e||nt.all;var t=W.caret(),n=W[0].selectionDirection,i=l(e);if(i.pre.add(i.post).length){var r=c(e);W.val(r.text),i.pre.remove(),i.post.remove(),W.caret(t.start+r.lengthBeforeInput,t.end+r.lengthBeforeInput),H&&(W[0].selectionDirection=n),I(),u()}}function f(e){if(i.operators&&i.operators.test(e))return $("<span class='rendered-element'/>").text(e);var t=s(e).addClass("rendered-element");return i.invalid&&i.invalid[e]&&t.addClass("invalid-tag").attr("title","invalid tag"),t}function h(t){if(!Y){var n;if(n=t?{"start":W.val().length,"end":W.val().length}:W.caret(),-1==n.start&&(n.start=n.end=0),!H&&n.start!==n.end)return p(),b(),void 0;var r=W.val(),a=r.substr(0,n.start),s=r.substr(n.end),l=W[0].selectionDirection,h=(a+"!").split(/[,;\s]+/);h[h.length-1]="!"===h[h.length-1]?"":h[h.length-1].slice(0,-1);var g=s.split(/[,;\s]+/),m=h.pop(),v=m.length;m+=r.substring(n.start,n.end),m+=g.shift(),h=sanitizeAndSplitTags(h.join(" "),!1,!!i.operators),g=sanitizeAndSplitTags(g.join(" "),!1,!!i.operators);var x,w=!!h.length||!!g.length;for(x=0;x<h.length;x++)f(h[x]).appendTo(V);for(x=0;x<g.length;x++)f(g[x]).appendTo(K);m!==W.val()&&W.val(m);var y={};j.find(".rendered-element").filter(function(){var e=$(this).text();return/^\s*$/.test(e)?!0:y[e]===!0?!0:(i.operators&&i.operators.test(e)||(y[e]=!0),!1)}).remove();var k=c(),S=k.text;S!=e.val()&&(e.val(S).trigger("change"),StackExchange.MarkdownEditor&&styleCode.updateLangdivDelayed.trigger(S.split(/ /g))),w&&u(k),R&&(W.caret(v,v+n.end-n.start),H&&(W[0].selectionDirection=l),E(),o()),b(),d()?W.attr("placeholder",D):W.attr("placeholder","")}}function g(e,t,n,r){var a,o;if("string"==typeof e)o=e;else{if(!e.length)return;a=e,o=a.text()}for(var s=sanitizeAndSplitTags(W.val(),!1,!!i.operators),l=0;l<s.length;l++)f(s[l]).appendTo(V);if(W.val(o),a){var c=$($.unique(a.prevAll(".rendered-element").get()));a.nextAll(".rendered-element").prependTo(K),c.appendTo(V),a.remove()}else K.find(".rendered-element").appendTo(V);(R||!n)&&W.focus(),t&&W.caret(0,0),r||u()}function m(e){var t=e.val(),n="c_"+t;if(n in it)return it[n];var i=$("<span />").css({"font-family":e.css("font-family"),"font-size":e.css("font-size"),"display":"inline-block"});i.text(e.val()),i.insertAfter(e);var r=i.innerWidth();return i.remove(),it[n]=r,r}function v(e){i.multiLine||e!==rt&&(V.add(W).add(K).css({"position":"relative","left":e}),rt=e)}function b(){var e=m(W)+19,t=V.outerWidth();if(i.multiLine||K.children().length||(e=Math.max(e,N-t-8)),W.css("width",e),i.multiLine){var n=W.position().top,r=n;if(r>0&&z>r+B)return;if(n+j.scrollTop()+B<z)return j.scrollTop(0),void 0;j.scrollTop(n-(z-B)/2+j.scrollTop())}else{if(t+rt>0&&N>t+rt+e)return;if(N>t+e)return v(0),void 0;v(-t+(N-e)/2)}}function x(e,t){var n;n=e>0?K.find("> *"):V.find("> *");for(var i,r,a=W.position(),o=W.val().length,s=o>0?W.caret().start/o:.5,l=a.left+W.width()*s,c=0;c<n.length;c++){var u=n.eq(e>0?c:n.length-c-1),d=u.position();if("undefined"!=typeof r){if(d.top!==r)break}else{var f=Math.abs(d.top-a.top);if(!(f>B/2))continue;r=d.top}var h=d.left+u.width()/2;if(0>e&&l>h||e>0&&h>l){i=i||u;break}i=u}if(i){if(t){for(;i.parent().length;)p(e>0?nt.right:nt.left);W.caret(0,W.val().length)}else g(i);return!0}return!1}function w(){Z=!0,setTimeout(function(){Z=!1},0)}function y(e){if(!H&&e.shiftKey&&at[e.which]||e.ctrlKey&&65===e.which)return p(),!0;var t,n,r=W.caret(),a=W[0].selectionDirection,o="forward"===a?r.end:r.start,s=o===W.val().length,l=0===o;switch(e.which){case 37:return l?(t=V.find(".rendered-element:last"),t.length?(e.shiftKey?p(nt.left):g(t),e.shiftKey):!0):!0;case 39:return s?(n=K.find(".rendered-element:first"),n.length?(e.shiftKey?p(nt.right):g(n,!0),e.shiftKey):!0):!0;case 8:return l?(t=V.find(".rendered-element:last"),t.length?(W.val(t.text()+W.val()),W.caret(t.text().length,t.text().length),t.remove(),u(),!1):!0):!0;case 46:return s?(n=K.find(".rendered-element:first"),n.length?(W.val(W.val()+n.text()),W.caret(o,o),n.remove(),u(),!1):!0):!0;case 38:if(i.multiLine&&x(-1,e.shiftKey))return!1;case 36:return t=V.find(".rendered-element:first"),t.length?(e.shiftKey?p(nt.all_left):g(t,!0),e.shiftKey):!0;case 40:var c=$(".tag-suggestions > div:first");if(c.length)return w(),c.focus(),!1;if(i.multiLine&&x(1,e.shiftKey))return!1;case 35:return n=K.find(".rendered-element:last"),n.length?(e.shiftKey?p(nt.all_right):g(n),e.shiftKey):!0;case 9:w();break;case 27:I(),e.preventDefault(!0);break;case 13:if($(".tag-suggestions").length)return!1}return!0}function k(e){var t=e.find("p.more-info");"undefined"==typeof tt&&(tt=U-5-t.outerWidth());var n=e.find(".rendered-element:first").outerWidth()+e.find(".item-multiplier").outerWidth();n>tt&&t.find("a").text("info")}function S(e,t){$(".tag-suggestions").remove(),Y=!1;var n=e.length;if(0!==n){var r=z;i.multiLine&&(r=j.height());var a=$("<div class='tag-suggestions' />").css({"position":"absolute","left":j.position().left,"top":j.position().top+r+1,"width":q-10}).insertAfter(j),o={};j.find(".rendered-element").each(function(){o[$(this).text()]=!0});for(var s=0;s<e.length;s++)if(o[e[s].Name]!==!0){var l=C(e[s],t).appendTo(a).attr("tabindex",G||0);k(l),s%M===0&&l.css("clear","both")}a.delegate("div","keydown",A),a.delegate("div","click",function(e){$(e.target).is("a")||_($(this))}),a.delegate("div","focus",function(){Z&&1===n?_($(this)):Y=!0}),a.delegate("div","blur",function(){Y=!1})}}function E(){var e=sanitizeAndSplitTags(W.val(),!1,!!i.operators)[0];if(et!==e)return et=e,e&&e.length?(T(e,function(t){e===et&&R&&S(t,e)}),void 0):(I(),void 0)}function C(e,t){var n=$("<div />").css("width",U).data("tag-name",e.SynonymOf||e.Name);t&&(t=t.replace(/-/g,"").replace(/(.)(?=.)/g,"$1-*").replace(/\+/g,"\\+").replace(/\./g,"\\."));var i=s(e.Name,!0),r=i.html();if(t&&(r=r.replace(new RegExp("("+t+")"),"<span class='match'>$1</span>")),n.append(i.html(r)),e.Count&&n.append($("<span class='item-multiplier' />").html("&times;&nbsp;"+e.Count)),P){var a="";if(e.Excerpt&&(a=e.Excerpt),a.length&&n.append($("<p />").text(a)),e.Synonyms&&e.Synonyms.length)for(var o=$("<p >also:</p>").appendTo(n),l=e.Synonyms.split(/\|/),c=0;c<l.length;c++)a=l[c],t&&(a=a.replace(new RegExp("("+t+")"),"<span class='match'>$1</span>")),c>0&&(a=", "+a),o.append("<span>"+a+"</span>")}return O&&n.append("<p class='more-info'><a href='/tags/"+encodeURIComponent(e.SynonymOf||e.Name)+"/info' target='_blank'>learn more</a></p>"),n}function T(e,t){ot["t_"+e]?t(ot["t_"+e]):st.trigger(e,t)}function _(e){W.val(e.data("tag-name")),I(),g(""),h()}function I(){$(".tag-suggestions").remove(),Y=!1,st.cancel()}function A(e){var t;switch(e.which){case 39:case 40:return $(this).next("div").focus(),!1;case 37:return $(this).prev("div").focus(),!1;case 38:return t=$(this).prev("div"),t.length?t.focus():W.focus(),!1;case 27:return I(),W.focus(),!1;case 13:case 32:return _($(this)),!1}}var R;if("undefined"==typeof n)try{R=e.is(":focus")}catch(L){R=!1}else R=n;if(e.bind("focus",r),!e.is(":visible"))return t=t||0,3>t?(setTimeout(function(){e.unbind("focus",r),StackExchange.tagEditor(e,t+1,R)},300),void 0):(e.unbind("focus",r),$("body.review-task-page").length||StackExchange.debug.log("tag box is invisible, couldn't start tag editor"),void 0);i||(i={});var M=i.columns||3,P="undefined"==typeof i.excerpts||i.excerpts,O="undefined"==typeof i.learnMore||i.learnMore,D=e.attr("placeholder")||"";e.unbind("focus",r);var N=e.innerWidth(),q=i.suggestionsWidth||N,U=(q-40)/M|0,j=$("<div class='tag-editor' />").css("width",N).insertAfter(e);i.multiLine&&j.addClass("multi-line");var H="selectionDirection"in e[0];e.hide();var F=$("<span class='post-tag'>test</span>").appendTo(j),B=j.innerHeight(),z=i.multiLine?e.innerHeight():B;F.remove(),j.css("height",z);var V=$("<span />").appendTo(j),W=$("<input type='text' tabIndex='0'/>").appendTo(j).val(e.val()+" ").attr("placeholder",D),K=$("<span />").appendTo(j),G=e.attr("tabIndex");G&&W.attr("tabIndex",G);var Q,Y=!1,J=R;W.focus(function(t,n){R=!0,o(),J||(n||e.triggerHandler("focus",!0),J=!0)});var X=!1;j.mousedown(function(){X=!0,$(document).one("mouseup",function(){setTimeout(function(){R||(e.triggerHandler("blur"),J=!1),X=!1},0)})}),W.blur(function(){R=!1,setTimeout(function(){Y||(I(),h(),X||(e.triggerHandler("blur"),J=!1)),X=!1},0)}),e.focus(function(e,t){t||W.trigger("focus",!0)}),W.keydown(y),W.bind("keydown paste click change",function(){setTimeout(function(){h()},0)}),j.delegate(".rendered-element","click",function(e){var t=$(this);$(e.target).hasClass("delete-tag")&&t.text(""),g(t),h()}),j.click(function(e){e.target===this&&(g(""),h())}),j.on("rerender",function(){p(),h(!0)});var Z,et,tt,nt={"left":1,"right":2,"all_left":3,"all_right":4,"all":5},it={},rt=0,at={"35":!0,"36":!0,"37":!0,"38":!0,"39":!0,"40":!0},ot={},st=StackExchange.helpers.DelayedReaction(function(e,t){StackExchange.helpers.addSpinner(j,{"position":"absolute","right":10,"top":z/2-2}),$.get("/filter/tags",{"q":e,"newstyle":!0},"json").done(function(n){ot["t_"+e]=n,StackExchange.helpers.removeSpinner(),t(n)})},400,{"sliding":!0});h(!0),StackExchange.helpers.genericBindOverlayEvents(j,W,d),StackExchange.tagEditor.ready.resolve(),e[0].func_clear=function(){e.val(""),W.val("").blur(),j.find(".rendered-element").remove()},e[0].func_add=function(e){var t=W.val();W.val(e),g(t,!1,!0),h()},e[0].func_finish=function(){g("")},e[0].func_redraw=function(){var t=e.val();e.val(""),W.val("").blur(),j.find(".rendered-element").remove(),W.val(t),g("",!1,!0,!0),h()}},StackExchange.tagEditor.ready=$.Deferred();